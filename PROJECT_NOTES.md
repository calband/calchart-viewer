# Calchart Viewer - Project Architecture & Build Notes

## Project Overview
**Calchart Viewer** is a web application built for Cal Band that allows members to:
1. Preview fieldshow charting from JSON files generated by Calchart (backend)
2. Highlight their specific dot/position and step through the show with synchronized music
3. Generate PDF printouts of their individual continuity/moves for a show

**URL:** http://calband.github.io/calchart-viewer/  
**Type:** Single-page web application with three entry points (desktop, mobile, PDF)

---

## Architecture

### High-Level Design
The application uses a **Controller-based architecture** with the `ApplicationController` as the central orchestrator:

```
User Input (File Upload/Selection)
    ↓
ApplicationController (Singleton)
    ├── Grapher (Rendering/Visualization)
    ├── MusicAnimator (Audio sync)
    ├── AnimationStateDelegate (Playback state)
    └── Show (Data model)
```

Detailed architecture diagram: http://imgur.com/yw7FbWL.png

### Core Components

#### 1. **Entry Points** (3 versions)
- **`index.html`** - Desktop version (full-featured)
  - Loads: `build/js/application.js`, vendor libraries (jQuery, D3, jsPDF, SoundManager2)
  - CSS: `app.css`, `graph.css`
- **`mobile.html`** - Mobile-optimized version
  - Loads: `build/js/mobile.js`
  - CSS: `mobile.css`
  - Simplified UI, direct jump to PDF continuity view
- **`pdf.html`** - PDF generation view
  - Loads: `build/js/pdf.js`
  - Generates individual continuity PDFs with configurable layout options

#### 2. **Core Data Model** (`js/viewer/`)
- **`Show.js`** - Represents an entire fieldshow
  - Properties: title, year, description, dot labels, sheets array
  - Methods: getters for show metadata, sheet access
  
- **`Sheet.js`** - Single stuntsheet/formation
  - Contains dot positions, types, continuity text for one moment in the show
  
- **`Dot.js`** - Individual performer/dot
  - Position (x, y coordinates), label, type, continuity info
  
- **`MovementCommand.js`** & variants (`MovementCommandMove.js`, `MovementCommandArc.js`, etc.)
  - Represents how a dot moves between sheets
  - Types: Move, Arc, Stand, Even, Goto, MarkTime, Close

#### 3. **Animation & Playback** (`js/viewer/player/`)
- **`MusicAnimator.js`** - Main animation loop orchestrator
  - Syncs visual animation with music playback
  
- **`MusicPlayer.js`** & **`MusicPlayerFactory.js`**
  - Factory pattern to create appropriate player (uses SoundManager2)
  
- **`Sound.js`** - Audio wrapper
  - Handles music file loading and playback control

- **`AnimationStateDelegate.js`** - State management for playback
  - Tracks current beat, sheet index, playback progress
  - Delegates animation updates to Grapher

#### 4. **Rendering** (`js/viewer/`)
- **`Grapher.js`** - D3.js visualization engine
  - Renders dots on field with correct positions
  - Updates on animation state changes
  - Highlights selected dot
  - Manages visual layers for continuity display

#### 5. **File Loading** (`js/viewer/fileLoad/`)
- **`FileLoadSelector.js`** - Base class for file selection
- **`ViewerFileLoadSelector.js`** - Loads viewer JSON files (show data)
- **`BeatsFileLoadSelector.js`** - Loads beats JSON files (music timing)
- **`InvalidFileTypeError.js`** - Custom error for invalid files

#### 6. **PDF Generation** (`js/pdf/`)
- **`PDFGenerator.js`** - Main PDF generation using jsPDF
- **`PDFUtils.js`** - Utility functions for PDF rendering
- **`PDFWidget.js`** - Base widget class for PDF components
- Widget types:
  - `HeaderWidget.js` - Title/show info
  - `MovementDiagramWidget.js` - Visual representation of moves
  - `IndividualContinuityWidget.js` - Text continuity for one dot
  - `DotContinuityWidget.js` - Visual dot with surrounding context
  - `BirdsEyeWidget.js` - Overhead view of field
  - `SurroundingDotsWidget.js` - Context of nearby dots

#### 7. **Utilities** (`js/viewer/utils/`)
- **`ShowUtils.js`** - Show data manipulation helpers
- **`TimedBeatsUtils.js`** - Beat timing calculations
- **`ArrayUtils.js`** - Array operations
- **`MathUtils.js`** - Mathematical calculations (coordinates, distances)
- **`JSUtils.js`** - General JavaScript utilities (URL params, etc.)

#### 8. **Application Controller** (`js/viewer/ApplicationController.js`)
The singleton that ties everything together:
- Manages the currently loaded Show
- Loads shows from Calchart server (`https://calchart-server.herokuapp.com/list/`)
- Handles file uploads and parsing
- Coordinates between Grapher, MusicAnimator, and UI
- Syncs animation state with playback
- Manages UI updates (dropdown selectors, play controls, etc.)

---

## Build System Details

See the README for basic build instructions. The following describes how the build system works internally.

### Technology Stack
- **Build Tool:** Grunt (task runner)
- **Module Bundler:** Webpack (CommonJS module loading)
- **CSS Preprocessor:** LESS
- **Vendor Libraries:**
  - jQuery 1.11.1 - DOM manipulation
  - D3.js - Visualization
  - jsPDF - PDF generation
  - SoundManager2 - Cross-browser audio
  - Chosen.js - Styled dropdowns

### How It Works

**Grunt Configuration** (`Gruntfile.js`) orchestrates three main tasks:
1. `less` - Compiles `css/**/*.less` → `build/css/**/*.css`
2. `webpack:build` - Bundles three entry points with dependencies
3. `watch` - Auto-rebuilds on file changes

**Webpack Bundling** creates three independent bundles:
- `application.js` - Desktop app (entry: `js/application.js`)
- `pdf.js` - PDF generator (entry: `js/pdf.js`)
- `mobile.js` - Mobile app (entry: `js/mobile.js`)

All use CommonJS `require()` for module imports, which Webpack resolves at build time.

**Output Structure:**
- CSS: `build/css/app.css`, `graph.css`, `mobile.css`, `pdf.css`, `utils.css`
- JS: `build/js/application.js`, `mobile.js`, `pdf.js`

---

## Deployment Details

Two deployment targets exist, both using shell scripts in `scripts/`.

### Production → `http://calband.github.io/calchart-viewer/`

**Script:** `scripts/push.sh`  
**Command:** `source scripts/push.sh`

Process:
1. Verifies you're on `master` branch
2. Pulls latest from `origin/master`
3. Checks out and pulls `gh-pages` branch
4. Merges `master` into `gh-pages`
5. Runs `grunt build` to generate static files
6. Commits with message "Built production files"
7. Pushes to GitHub Pages
8. Returns to `master` branch

**GitHub Pages Setup:** Site deployed from `gh-pages` branch at https://github.com/calband/calchart-viewer

### Demo/Testing → `http://calband.github.io/calchart-viewer-demo/`

**Script:** `scripts/push_demo.sh`  
**Command:** `source scripts/push_demo.sh`

Process:
1. Validates working directory is clean
2. Creates temporary `demo-master` branch
3. Modifies `.gitignore` (excludes node_modules only)
4. Runs `grunt build` and commits generated files
5. Force-pushes to separate `calchart-viewer-demo` repository
6. Cleans up temporary branch
7. Rebuilds current branch to restore dev state

**Requirements:**
- Must have added the demo remote: `git remote add demo <git-url>`
- Working directory must have no uncommitted changes
- Used for testing features before production release

---

## Input Data Formats

### Viewer File Format (`viewer.json`)
Defines the show structure and dots:

```json
{
  "meta": {
    "version": "1.0.0",
    "index_name": "2013-pixar-show",
    "type": "viewer"
  },
  "show": {
    "title": "The Pixar Show",
    "year": "2013",
    "description": "Show description",
    "labels": ["A1", "A2", ...],  // All dot labels
    "sheets": [
      {
        "label": "1",              // Sheet number
        "field_type": "college",   // college, high-school, etc.
        "dot_types": ["solid", "open", ...],
        "dot_labels": {            // Map: dot_label → type
          "A1": "solid",
          "A2": "open"
        },
        "continuities": {          // Map: type → [text descriptions]
          "solid": ["MT 12 E", "FMHS to SS 2"],
          "open": ["FMHS to SS 2"]
        }
      }
    ]
  }
}
```

### Beats File Format (`beats.json`)
Timing information for music:

```json
{
  "meta": {
    "version": "1.0.0",
    "index_name": "2013-pixar-show",
    "type": "beats"
  },
  "beats": [
    100,    // Milliseconds from start (or from last beat)
    100,
    200,
    ...
  ]
}
```

---

## Development Workflow

See README for basic setup. Additional notes for development:

### File Upload Flow

When a user selects `viewer.json` and `beats.json` files:
1. `FileLoadSelector` subclasses parse the JSON files
2. `Show` object is constructed from viewer JSON
3. `TimedBeats` object is constructed from beats JSON
4. `ApplicationController.setShow()` initializes animation system
5. `AnimationStateDelegate` is created for the show
6. `Grapher` renders the first sheet using D3
7. `MusicAnimator` prepares audio playback
8. UI updates with available dots and playback controls

### Key Development Patterns

- **Singleton:** `ApplicationController.getInstance()` returns the single shared instance
- **Module Loading:** Uses CommonJS `require()` enabled by Webpack
- **Entry Points:** Separate bundles for desktop/mobile/PDF - don't mix their logic
- **Core vs UI:** Shared code in `js/viewer/`, entry point-specific code in root `js/*.js`

---

## Key Technologies & Libraries

| Tech | Purpose | Notes |
|------|---------|-------|
| jQuery | DOM manipulation, AJAX | v1.11.1 (old but stable) |
| D3.js | Data visualization | Renders dots on field |
| Webpack | Module bundling | Enables CommonJS `require()` |
| LESS | CSS preprocessing | Reduces CSS duplication |
| Grunt | Task automation | Orchestrates build pipeline |
| jsPDF | PDF generation | Creates downloadable continuity PDFs |
| SoundManager2 | Audio playback | Cross-browser audio with Flash fallback |
| Chosen.js | UI enhancement | Styled dropdown selectors |

---

## Important Notes

1. **Singleton Pattern:** `ApplicationController` uses singleton pattern - access via `ApplicationController.getInstance()`

2. **Module Loading:** Uses CommonJS `require()` after Webpack bundling. All JS modules should use this pattern.

3. **CSS Structure:** 
   - Five separate CSS files for organization (app, graph, mobile, pdf, utils)
   - All are generated from LESS → CSS through Grunt

4. **GitHub Pages:** Uses `gh-pages` branch for serving live site (not `master`)

5. **Calchart Server Integration:** App fetches available shows from external Calchart server at `https://calchart-server.herokuapp.com/list/`

6. **Three UI Variants:** Desktop, mobile, and PDF are essentially separate applications sharing core library code

7. **Build Output:** Only `build/` directory needs to be versioned for deployment (but currently tracked in git)

8. **No Database:** All data comes from JSON files uploaded by user or fetched from Calchart server

---

## Show Publishing Workflow

Shows are published to the calchart-server by band members through a web-based admin interface (separate from the viewer):

1. **Create/Upload Show:** Band members log into calchart-server with Members Only credentials
2. **Upload Files:** Submit viewer JSON and beats JSON files via the home page form
3. **Edit (Optional):** Use the beats editor to adjust timing if needed
4. **Publish:** Toggle the "published" flag to make the show visible to the viewer app
5. **Access:** Once published, shows appear in the dropdown list fetched by the viewer app

**calchart-server Endpoints:**
- `GET /list/` - Returns published shows available in the viewer
- `GET /get/<slug>/` - Returns viewer JSON for a show (internal, used by server)
- `GET /viewer/<slug>/` - Returns viewer JSON for a show
- `GET /beats/<slug>/` - Returns beats JSON for a show

The server is a Django application that validates JSON files before storing them in a database. The viewer app has no upload capability—it only consumes published shows from the server.

---

## File Organization Summary

```
/js/
  ├── application.js       [Entry point - desktop]
  ├── mobile.js           [Entry point - mobile]
  ├── pdf.js              [Entry point - PDF]
  ├── vendor/             [3rd party libraries]
  ├── viewer/             [Core app logic]
  │   ├── ApplicationController.js
  │   ├── Grapher.js      [D3 rendering]
  │   ├── Show.js         [Data model]
  │   ├── Sheet.js
  │   ├── Dot.js
  │   ├── AnimationState*.js
  │   ├── MovementCommand*.js
  │   ├── fileLoad/       [File parsing]
  │   ├── player/         [Audio control]
  │   └── utils/          [Helper functions]
  └── pdf/                [PDF generation]

/css/
  ├── *.less              [LESS source files]
  └── vendor/             [Vendor CSS]

/build/                   [Generated output]
  ├── js/                 [Webpack bundles]
  └── css/                [Compiled CSS]

/other/
  ├── file-formats/       [JSON schema documentation]
  ├── dummy/              [Sample files for testing]
  └── fonts/

/scripts/                 [Deployment scripts]
  ├── push.sh            [Production deploy]
  └── push_demo.sh       [Demo deploy]
```

---

## Next Steps for Future Development

When starting new work, consider:
1. Check `grunt watch` is running if making CSS/JS changes
2. Understand which entry point to modify (application, mobile, or pdf)
3. Core logic belongs in `js/viewer/` shared by all three
4. UI-specific code goes in respective entry point
5. After changes, test in browser and check console for errors
6. Run `grunt build` before deployment
7. Use `scripts/push.sh` for production or `scripts/push_demo.sh` for testing
